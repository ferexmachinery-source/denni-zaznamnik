<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Denní záznamník práce</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #27ae60;
            --warning-color: #e74c3c;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            border: 1px solid #eee;
        }
        
        h1, h2, h3 {
            margin-bottom: 15px;
            color: var(--dark-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        button.delete {
            background-color: var(--warning-color);
        }
        
        button.delete:hover {
            background-color: #c0392b;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table, th, td {
            border: 1px solid #ddd;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: var(--light-color);
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-day {
            border: 1px solid #ddd;
            padding: 12px;
            min-height: 100px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .calendar-day:hover {
            background-color: #f0f8ff;
        }
        
        .current-date {
            background-color: var(--primary-color);
            color: white;
        }
        
        .has-entries {
            background-color: #e8f5e9;
        }
        
        .work-entry {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            background: #f9f9f9;
        }
        
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--light-color);
            border-radius: 6px;
        }
        
        .config-section {
            background: #fff8e1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-color);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 8px;
                font-size: 14px;
            }
            
            .nav {
                flex-direction: column;
                gap: 10px;
            }
            
            button {
                width: 100%;
                margin-bottom: 10px;
            }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Denní záznamník práce</h1>
        </header>
        
        <div class="config-section">
            <h2>Konfigurace JSONBin.io</h2>
            <div class="form-group">
                <label for="binId">ID vašeho BINu:</label>
                <input type="text" id="binId" placeholder="Vložte ID vašeho BINu">
            </div>
            <div class="form-group">
                <label for="apiKey">Váš API klíč:</label>
                <input type="text" id="apiKey" placeholder="Vložte váš API klíč">
            </div>
            <button id="saveConfig">Uložit konfiguraci</button>
            <p><small>Pokud nemáte BIN ID a API klíč, postupujte podle instrukcí v dokumentaci.</small></p>
        </div>
        
        <div class="section">
            <h2>Správa zaměstnanců</h2>
            <div class="form-group">
                <label for="employeeName">Jméno zaměstnance:</label>
                <input type="text" id="employeeName" placeholder="Zadejte jméno">
            </div>
            <button id="addEmployee">Přidat zaměstnance</button>
            
            <h3>Seznam zaměstnanců</h3>
            <table id="employeesTable">
                <thead>
                    <tr>
                        <th>Jméno</th>
                        <th>Akce</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>Kalendář</h2>
            <div class="nav">
                <button id="prevMonth">← Předchozí měsíc</button>
                <h3 id="currentMonth">Leden 2023</h3>
                <button id="nextMonth">Následující měsíc →</button>
            </div>
            <div class="calendar" id="calendar"></div>
        </div>
        
        <div class="section" id="dayEntriesSection" style="display: none;">
            <div class="day-header">
                <h2 id="selectedDateTitle">Práce pro datum: </h2>
                <button id="closeDayView">✕ Zavřít</button>
            </div>
            <div id="dayEntries"></div>
            
            <h3>Přidat záznam práce</h3>
            <div class="form-group">
                <label for="selectEmployee">Zaměstnanec:</label>
                <select id="selectEmployee"></select>
            </div>
            <div class="form-group">
                <label for="workDescription">Popis práce:</label>
                <textarea id="workDescription" rows="3" placeholder="Popište provedenou práci"></textarea>
            </div>
            <button id="addWorkEntry">Přidat záznam</button>
        </div>
        
        <div class="section">
            <h2>Export týdenního reportu</h2>
            <div class="form-group">
                <label for="reportEmployee">Zaměstnanec:</label>
                <select id="reportEmployee"></select>
            </div>
            <div class="form-group">
                <label for="reportWeek">Týden:</label>
                <input type="week" id="reportWeek">
            </div>
            <button id="generateReport">Generovat report</button>
        </div>
    </div>

    <script>
        // Data aplikace
        let employees = [];
        let workEntries = [];
        let currentDate = new Date();
        let selectedDate = new Date();
        let binId = '';
        let apiKey = '';
        
        // DOM prvky
        const calendarEl = document.getElementById('calendar');
        const currentMonthEl = document.getElementById('currentMonth');
        const dayEntriesSectionEl = document.getElementById('dayEntriesSection');
        const selectedDateTitleEl = document.getElementById('selectedDateTitle');
        const dayEntriesEl = document.getElementById('dayEntries');
        const selectEmployeeEl = document.getElementById('selectEmployee');
        const reportEmployeeEl = document.getElementById('reportEmployee');
        const employeesTableEl = document.getElementById('employeesTable').querySelector('tbody');
        const binIdEl = document.getElementById('binId');
        const apiKeyEl = document.getElementById('apiKey');
        
        // Inicializace aplikace
        document.addEventListener('DOMContentLoaded', () => {
            // Načtení konfigurace z localStorage
            const savedConfig = localStorage.getItem('workLoggerConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                binId = config.binId;
                apiKey = config.apiKey;
                binIdEl.value = binId;
                apiKeyEl.value = apiKey;
            }
            
            initEventListeners();
            if (binId && apiKey) {
                loadData();
            } else {
                alert('Pro správné fungování aplikace je nutné nejprve vyplnit konfiguraci JSONBin.io.');
            }
        });
        
        // Inicializace posluchačů událostí
        function initEventListeners() {
            document.getElementById('addEmployee').addEventListener('click', addEmployee);
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
            document.getElementById('addWorkEntry').addEventListener('click', addWorkEntry);
            document.getElementById('generateReport').addEventListener('click', generateReport);
            document.getElementById('saveConfig').addEventListener('click', saveConfig);
            document.getElementById('closeDayView').addEventListener('click', () => {
                dayEntriesSectionEl.style.display = 'none';
            });
        }
        
        // Uložení konfigurace
        function saveConfig() {
            binId = binIdEl.value.trim();
            apiKey = apiKeyEl.value.trim();
            
            if (binId && apiKey) {
                localStorage.setItem('workLoggerConfig', JSON.stringify({ binId, apiKey }));
                alert('Konfigurace uložena. Načítám data...');
                loadData();
            } else {
                alert('Vyplňte prosím obě pole konfigurace.');
            }
        }
        
        // Načtení dat z JSONBin.io
        async function loadData() {
            if (!binId || !apiKey) {
                console.error('Chybí konfigurace JSONBin.io');
                return;
            }
            
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Master-Key': apiKey,
                        'X-Bin-Meta': false
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Chyba při načítání: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                employees = data.employees || [];
                workEntries = data.workEntries || [];
                
                renderEmployees();
                renderCalendar();
                updateEmployeeSelects();
            } catch (error) {
                console.error('Chyba při načítání dat:', error);
                alert('Chyba při načítání dat: ' + error.message);
            }
        }
        
        // Uložení dat na JSONBin.io
        async function saveData() {
            if (!binId || !apiKey) {
                console.error('Chybí konfigurace JSONBin.io');
                return;
            }
            
            try {
                const data = {
                    employees,
                    workEntries
                };
                
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': apiKey,
                        'X-Bin-Name': 'Work Logger Data'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`Chyba při ukládání: ${response.status} ${response.statusText}`);
                }
                
                console.log('Data úspěšně uložena');
            } catch (error) {
                console.error('Chyba při ukládání dat:', error);
                alert('Chyba při ukládání dat: ' + error.message);
            }
        }
        
        // Přidání zaměstnance
        function addEmployee() {
            const nameInput = document.getElementById('employeeName');
            const name = nameInput.value.trim();
            
            if (name && !employees.includes(name)) {
                employees.push(name);
                nameInput.value = '';
                renderEmployees();
                updateEmployeeSelects();
                saveData();
            } else if (employees.includes(name)) {
                alert('Tento zaměstnanec již existuje.');
            }
        }
        
        // Smazání zaměstnance
        function deleteEmployee(index) {
            if (confirm('Opravdu chcete smazat tohoto zaměstnance? Všechny jeho záznamy práce budou také smazány.')) {
                const employeeName = employees[index];
                employees.splice(index, 1);
                
                // Odstranit související záznamy práce
                workEntries = workEntries.filter(entry => entry.employee !== employeeName);
                
                renderEmployees();
                updateEmployeeSelects();
                if (dayEntriesSectionEl.style.display === 'block') {
                    renderDayEntries();
                }
                saveData();
            }
        }
        
        // Vykreslení seznamu zaměstnanců
        function renderEmployees() {
            employeesTableEl.innerHTML = '';
            
            if (employees.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 2;
                cell.textContent = 'Žádní zaměstnanci nebyli přidáni.';
                row.appendChild(cell);
                employeesTableEl.appendChild(row);
                return;
            }
            
            employees.forEach((employee, index) => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.textContent = employee;
                
                const actionCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Smazat';
                deleteBtn.classList.add('delete');
                deleteBtn.addEventListener('click', () => deleteEmployee(index));
                
                actionCell.appendChild(deleteBtn);
                
                row.appendChild(nameCell);
                row.appendChild(actionCell);
                
                employeesTableEl.appendChild(row);
            });
        }
        
        // Aktualizace selectů pro výběr zaměstnance
        function updateEmployeeSelects() {
            selectEmployeeEl.innerHTML = '';
            reportEmployeeEl.innerHTML = '';
            
            employees.forEach(employee => {
                const option1 = document.createElement('option');
                option1.value = employee;
                option1.textContent = employee;
                
                const option2 = document.createElement('option');
                option2.value = employee;
                option2.textContent = employee;
                
                selectEmployeeEl.appendChild(option1);
                reportEmployeeEl.appendChild(option2);
            });
        }
        
        // Změna zobrazeného měsíce
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }
        
        // Vygenerování kalendáře
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthNames = ['Leden', 'Únor', 'Březen', 'Duben', 'Květen', 'Červen', 
                               'Červenec', 'Srpen', 'Září', 'Říjen', 'Listopad', 'Prosinec'];
            currentMonthEl.textContent = `${monthNames[month]} ${year}`;
            
            // Získat první den měsíce a poslední den měsíce
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Získat den v týdnu pro první den (0 = Neděle, 1 = Pondělí, ...)
            let firstDayOfWeek = firstDay.getDay();
            if (firstDayOfWeek === 0) firstDayOfWeek = 7; // Neděli posuneme na konec
            firstDayOfWeek--; // Upravíme na rozsah 0-6 (Pondělí-Neděle)
            
            // Počet dní v měsíci
            const daysInMonth = lastDay.getDate();
            
            // Vyprázdnění kalendáře
            calendarEl.innerHTML = '';
            
            // Přidat názvy dnů v týdnu
            const dayNames = ['Po', 'Út', 'St', 'Čt', 'Pá', 'So', 'Ne'];
            dayNames.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.style.fontWeight = 'bold';
                dayEl.style.textAlign = 'center';
                calendarEl.appendChild(dayEl);
            });
            
            // Přidat prázdné buňky před první den
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyEl = document.createElement('div');
                emptyEl.classList.add('calendar-day');
                calendarEl.appendChild(emptyEl);
            }
            
            // Přidat dny v měsíci
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('calendar-day');
                
                const dayNumber = document.createElement('div');
                dayNumber.textContent = day;
                dayNumber.style.marginBottom = '5px';
                dayEl.appendChild(dayNumber);
                
                const date = new Date(year, month, day);
                if (date.getTime() === today.getTime()) {
                    dayEl.classList.add('current-date');
                }
                
                // Zkontrolovat, zda jsou pro tento den nějaké záznamy
                const entriesForDay = workEntries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    return entryDate.getFullYear() === year && 
                           entryDate.getMonth() === month && 
                           entryDate.getDate() === day;
                });
                
                if (entriesForDay.length > 0) {
                    dayEl.classList.add('has-entries');
                    
                    const entriesCount = document.createElement('div');
                    entriesCount.textContent = `${entriesForDay.length} záznam(ů)`;
                    entriesCount.style.fontSize = '12px';
                    entriesCount.style.color = '#388e3c';
                    dayEl.appendChild(entriesCount);
                }
                
                dayEl.addEventListener('click', () => selectDate(date));
                calendarEl.appendChild(dayEl);
            }
        }
        
        // Výběr data
        function selectDate(date) {
            selectedDate = new Date(date);
            selectedDate.setHours(0, 0, 0, 0);
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            selectedDateTitleEl.textContent = `Práce pro datum: ${selectedDate.toLocaleDateString('cs-CZ', options)}`;
            
            dayEntriesSectionEl.style.display = 'block';
            renderDayEntries();
        }
        
        // Vypsání záznamů pro vybraný den
        function renderDayEntries() {
            dayEntriesEl.innerHTML = '';
            
            const entriesForDate = workEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                entryDate.setHours(0, 0, 0, 0);
                return entryDate.getTime() === selectedDate.getTime();
            });
            
            if (entriesForDate.length === 0) {
                dayEntriesEl.innerHTML = '<p>Pro tento den nejsou žádné záznamy.</p>';
                return;
            }
            
            entriesForDate.forEach((entry, index) => {
                const entryEl = document.createElement('div');
                entryEl.classList.add('work-entry');
                
                entryEl.innerHTML = `
                    <h4>${entry.employee}</h4>
                    <p>${entry.description}</p>
                    <button class="delete" data-index="${index}">Smazat</button>
                `;
                
                dayEntriesEl.appendChild(entryEl);
            });
            
            // Přidání posluchačů pro tlačítka mazání
            document.querySelectorAll('.work-entry .delete').forEach(button => {
                button.addEventListener('click', (e) => {
                    const entryIndex = parseInt(e.target.getAttribute('data-index'));
                    deleteWorkEntry(entryIndex);
                });
            });
        }
        
        // Přidání záznamu práce
        function addWorkEntry() {
            const employee = selectEmployeeEl.value;
            const description = document.getElementById('workDescription').value.trim();
            
            if (employee && description) {
                workEntries.push({
                    date: selectedDate.toISOString(),
                    employee,
                    description
                });
                
                document.getElementById('workDescription').value = '';
                renderDayEntries();
                renderCalendar();
                saveData();
            } else {
                alert('Vyberte zaměstnance a zadejte popis práce.');
            }
        }
        
        // Smazání záznamu práce
        function deleteWorkEntry(index) {
            if (confirm('Opravdu chcete smazat tento záznam?')) {
                // Najít skutečný index v globálním seznamu workEntries
                const entryDate = new Date(workEntries[index].date);
                entryDate.setHours(0, 0, 0, 0);
                
                const globalIndex = workEntries.findIndex(entry => {
                    const eDate = new Date(entry.date);
                    eDate.setHours(0, 0, 0, 0);
                    return eDate.getTime() === entryDate.getTime() && 
                           entry.employee === workEntries[index].employee &&
                           entry.description === workEntries[index].description;
                });
                
                if (globalIndex !== -1) {
                    workEntries.splice(globalIndex, 1);
                    renderDayEntries();
                    renderCalendar();
                    saveData();
                }
            }
        }
        
        // Generování reportu
        function generateReport() {
            const employee = reportEmployeeEl.value;
            const weekInput = document.getElementById('reportWeek').value;
            
            if (employee && weekInput) {
                // Získat datumy pro vybraný týden
                const [year, week] = weekInput.split('-W');
                const firstDayOfYear = new Date(year, 0, 1);
                const daysToFirstMonday = firstDayOfYear.getDay() === 0 ? 1 : (8 - firstDayOfYear.getDay()) % 7;
                const firstMonday = new Date(year, 0, 1 + daysToFirstMonday);
                
                const startDate = new Date(firstMonday);
                startDate.setDate(firstMonday.getDate() + (week - 1) * 7);
                
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                
                // Najít záznamy pro vybraného zaměstnance v daném týdnu
                const employeeEntries = workEntries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    return entry.employee === employee && 
                           entryDate >= startDate && 
                           entryDate <= endDate;
                });
                
                // Seřadit záznamy podle data
                employeeEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Vytvořit obsah reportu
                let reportContent = `Týdenní report pro: ${employee}\n`;
                reportContent += `Týden: ${weekInput}\n`;
                reportContent += `Období: ${startDate.toLocaleDateString('cs-CZ')} - ${endDate.toLocaleDateString('cs-CZ')}\n\n`;
                
                // Seskupit záznamy podle data
                const entriesByDate = {};
                employeeEntries.forEach(entry => {
                    const entryDate = new Date(entry.date).toISOString().split('T')[0];
                    if (!entriesByDate[entryDate]) {
                        entriesByDate[entryDate] = [];
                    }
                    entriesByDate[entryDate].push(entry);
                });
                
                // Přidat záznamy do reportu
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    const dateString = currentDate.toISOString().split('T')[0];
                    
                    const dayNames = ['Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota', 'Neděle'];
                    const dayName = dayNames[i];
                    const formattedDate = currentDate.toLocaleDateString('cs-CZ');
                    
                    reportContent += `${dayName}, ${formattedDate}:\n`;
                    
                    if (entriesByDate[dateString]) {
                        entriesByDate[dateString].forEach(entry => {
                            reportContent += `- ${entry.description}\n`;
                        });
                    } else {
                        reportContent += '- Žádné záznamy\n';
                    }
                    
                    reportContent += '\n';
                }
                
                // Vytvořit a stáhnout soubor
                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${employee}_${weekInput}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                alert('Vyberte zaměstnance a týden.');
            }
        }
    </script>
</body>
</html>